<!--Creovue/thumbnail_eval/templates/face_detect.html -->
{% extends 'base.html' %}

{% block title %}Face Detection | Creovue{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .dropzone {
    border: 2px dashed #ccc;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    border-radius: 8px;
    transition: background 0.3s;
  }
  .dropzone.dragover {
    background: #e9ecef;
  }
  video {
    width: 100%;
    border-radius: 8px;
    margin-top: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>ðŸ§  Thumbnail Face Detection</h2>

  <form method="POST" enctype="multipart/form-data" class="mb-4" id="upload-form">
    <div id="dropzone" class="dropzone mb-3">
      <input type="file" name="thumbnail" id="thumbnail" accept="image/*" hidden required>
      <p>ðŸ“‚ Drag & drop your image here or click to select</p>
    </div>
    <button class="btn btn-primary" type="submit">Analyse</button>
  </form>

  <div class="mb-4">
    <h5>ðŸ“¸ Or Use Camera</h5>
    <video id="camera" autoplay muted></video>
    <button class="btn btn-outline-secondary mt-2" id="capture">Capture and Analyse</button>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  {% if image_url %}
    <div class="alert alert-info">Faces Detected: {{ faces_count }}</div>
    <img src="{{ image_url }}" alt="Detected Faces" class="img-fluid rounded border">
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Drag-and-drop logic
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('thumbnail');

  dropzone.addEventListener('click', () => fileInput.click());

  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('dragover');
  });

  dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('dragover');
  });

  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    fileInput.files = e.dataTransfer.files;
  });

  // Camera preview and capture
  const video = document.getElementById('camera');
  const canvas = document.getElementById('canvas');
  const captureBtn = document.getElementById('capture');

  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(err => console.error('Camera error:', err));
  }

  captureBtn.addEventListener('click', () => {
    const context = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(blob => {
      const form = document.getElementById('upload-form');
      const file = new File([blob], 'capture.jpg', { type: 'image/jpeg' });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;
      form.submit();
    }, 'image/jpeg');
  });
</script>
{% endblock %}
