{% extends "base.html" %}

{% block title %}Analytics | Creovue{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .analytics-container {
    padding: 2rem;
    background-color: #f8f9fa;
    border-radius: 1rem;
    box-shadow: 0 0.3rem 1rem rgba(0, 0, 0, 0.05);
  }

  .summary-cards-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .summary-card {
    border-left: 5px solid;
    border-radius: 10px;
    padding: 1.25rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    background-color: white;
    height: 100%;
  }

  .summary-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0.5rem 1.25rem rgba(0, 0, 0, 0.1);
  }

  .summary-card h5 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
  }

  .summary-card p {
    font-size: 1.75rem;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 0;
  }

  .chart-container {
    position: relative;
    height: 400px;
    background-color: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.07);
  }

  .card-blue { border-left-color: #007bff; }
  .card-green { border-left-color: #28a745; }
  .card-purple { border-left-color: #6f42c1; }
  .card-orange { border-left-color: #fd7e14; }
  .card-teal { border-left-color: #20c997; }

  /* Per Video Analytics Styles */
  .video-analytics-table {
  width: 100%;
  background-color: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.07);
  border-collapse: separate;
  border-spacing: 0 0.6rem;
}

.video-analytics-table thead th {
  background-color: #f1f5f9;
  padding: 1rem 1.2rem;
  font-weight: 600;
  text-align: left;
  color: #334155;
  border-bottom: 1px solid #e2e8f0;
}
.video-analytics-table tbody td {
  background-color: #ffffff;
  padding: 1rem 1.2rem;
  vertical-align: middle;
  border-top: none;
}

.video-analytics-table tbody tr {
  transition: all 0.2s ease;
  border-radius: 8px;
  margin-bottom: 1rem; /* Add this for extra space */
  display: table-row;
}

.video-analytics-table tbody tr:hover {
  background-color: #f8f9fc;
}


  .video-thumbnail {
    width: 120px;
    height: 68px;
    object-fit: cover;
    border-radius: 5px;
  }

  .video-title {
    font-weight: 500;
    color: #334155;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 300px;
  }

  .video-date {
    font-size: 0.875rem;
    color: #64748b;
  }

  .metric-value {
    font-weight: 600;
    color: #334155;
    font-size: 1.1rem;
  }

  .video-analytics-container {
    margin-top: 2rem;
  }

  .video-analytics-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .video-analytics-filters {
    display: flex;
    gap: 1rem;
  }

  .filter-select {
    padding: 0.5rem;
    border-radius: 5px;
    border: 1px solid #e2e8f0;
    background-color: white;
  }

  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
    gap: 0.5rem;
  }

  .pagination-button {
    padding: 0.5rem 0.75rem;
    border-radius: 5px;
    border: 1px solid #e2e8f0;
    background-color: white;
    cursor: pointer;
    transition: all 0.2s;
  }

  .pagination-button:hover {
    background-color: #f1f5f9;
  }

  .pagination-button.active {
    background-color: #3b82f6;
    color: white;
    border: 1px solid #3b82f6;
  }

  .no-videos-message {
    padding: 2rem;
    text-align: center;
    background-color: white;
    border-radius: 10px;
    color: #64748b;
  }

  

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .analytics-container {
      padding: 1rem;
    }
    
    .summary-card h5 {
      font-size: 1rem;
    }
    
    .summary-card p {
      font-size: 1.5rem;
    }
    
    .chart-container {
      height: 300px;
    }

    .video-analytics-table {
      display: block;
      overflow-x: auto;
    }

    .video-analytics-header {
      flex-direction: column;
      gap: 1rem;
    }

    .video-analytics-filters {
      flex-wrap: wrap;
    }
  }
</style>
<style>
  .modal.fade .modal-dialog {
    transition: transform 0.4s ease-out, opacity 0.3s ease-in-out;
    transform: translateY(20px);
  }

  .modal.show .modal-dialog {
    transform: translateY(0);
  }
</style>

{% endblock %}

{% block content %}
<div class="container analytics-container">
  <h2 class="mb-4 text-center">📊 Channel Performance Analytics</h2>

  <!-- Summary Cards -->
  <div class="row summary-cards-row">
    <div class="col-md-4">
      <div class="card summary-card card-blue shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Total Views</h5>
          <p class="display-6 fw-bold">{{ analytics.total_views }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card summary-card card-green shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Avg. Watch Time</h5>
          <p class="display-6 fw-bold">{{ analytics.avg_watch_time }} mins</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card summary-card card-purple shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Engagement Rate</h5>
          <p class="display-6 fw-bold">{{ analytics.engagement_rate }}%</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card summary-card card-orange shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Total Videos</h5>
          <p class="display-6 fw-bold">{{ analytics.video_count }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card summary-card card-teal shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Subscribers</h5>
          <p class="display-6 fw-bold">{{ analytics.subscriber_count }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
        <div class="card summary-card card-teal shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Most viewed:</h5>
            <p class="fw-bold">{{ analytics.most_viewed_video.title }}</p>
          </div>
        </div>
    </div>
  </div>


  <!-- Plot Section -->
  <div class="my-4">
    <h4 class="text-center mb-3">📈 Weekly View Trends</h4>
    <div class="chart-container">
      <canvas id="analyticsChart" aria-label="View Trends Chart" role="img"></canvas>
    </div>
  </div>
{#{ctr_metrics}#}
<p>
  {#{analytics.videos}#}
</p>

  <!-- Per Video Analytics Section -->
  <div class="video-analytics-container">
    <div class="video-analytics-header">
      <h4>🎬 Per Video Analytics</h4>
      <div class="video-analytics-filters">
        <select class="filter-select" id="sortBy">
          <option value="views_desc">Sort by: Views (High to Low)</option>
          <option value="views_asc">Sort by: Views (Low to High)</option>
          <option value="title">Sort by: Title</option>
          <option value="video_id">Sort by: Video ID</option>
        </select>
        <input type="text" class="filter-select" id="searchVideos" placeholder="Search videos...">
      </div>
    </div>
    
    <table class="video-analytics-table">
      <thead>
        <tr>
          <th>Thumbnail & Title</th>
          <th>Views</th>
          <th>Video ID</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for video in analytics.videos %}
        <tr>
          <td>
            <div class="d-flex align-items-center gap-3">
              <img src="https://img.youtube.com/vi/{{ video.video_id }}/mqdefault.jpg" alt="{{ video.title }}" class="video-thumbnail">
              <div class="video-title">{{ video.title }}</div>
            </div>
          </td>
          <td class="metric-value">{{ video.views }}</td>
          <td class="metric-value">{{ video.video_id }}</td>
          <td>
            <a href="https://www.youtube.com/watch?v={{ video.video_id }}" target="_blank" class="btn btn-sm btn-outline-primary">View on YouTube</a>
            <button class="btn btn-sm btn-outline-secondary" onclick="showVideoDetails('{{ video.video_id }}')">Details</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination">
      <button class="pagination-button">&lt;</button>
      <button class="pagination-button active">1</button>
      <button class="pagination-button">2</button>
      <button class="pagination-button">3</button>
      <button class="pagination-button">&gt;</button>
    </div>
  </div>
</div>

<!-- Video Detail Modal -->
<!-- Light-Themed Video Detail Modal -->
<div class="modal fade" id="videoDetailModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="videoDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-sm rounded-4" style="background-color: #ffffff;">
      <div class="modal-header border-0 bg-light">
        <h5 class="modal-title fw-semibold text-primary" id="videoDetailModalLabel">📊 Video Performance Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="videoDetailContent">
        <div class="text-center text-muted">Loading...</div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <a href="#" id="videoDetailLink" target="_blank" class="btn btn-outline-primary">🔗 Watch on YouTube</a>
        <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chartData = {
      labels: {{ chart_data["labels"] | tojson }},
      values: {{ chart_data["values"] | tojson }}
    };
    
    initAnalyticsChart(chartData);
    initPerVideoAnalytics();
  });

  function showVideoDetails(videoId) {
  const videos = {{ ctr_metrics.video_data | tojson | safe }};
  const video = videos.find(v => v.video_id === videoId);

  if (!video) return;

  const html = `
    <div class="d-flex flex-column flex-md-row gap-4 align-items-start mb-4">
      <img src="https://img.youtube.com/vi/${video.video_id}/mqdefault.jpg" 
           alt="${video.title}" 
           class="rounded shadow" 
           style="width: 240px; height: 135px; object-fit: cover; border: 2px solid #0ea5e9;">
      <div style="flex: 1;">
        <h5 class="fw-bold text-info mb-3">${video.title || 'Untitled Video'}</h5>
        <ul class="list-unstyled small" style="line-height: 1.6;">
          <li><strong>📽️ Video ID:</strong> <code>${video.video_id}</code></li>
          <li><strong>👁️ Views:</strong> ${video.views.toLocaleString()}</li>
          <li><strong>🎯 Impressions:</strong> ${video.impressions.toLocaleString()}</li>
          <li><strong>⚡ CTR:</strong> ${video.ctr.toFixed(2)}%</li>
          <li><strong>⏱️ Avg View Duration:</strong> ${video.avg_view_duration_seconds}s</li>
          <li><strong>🕒 Watch Time:</strong> ${video.watchTime} mins</li>
          <li><strong>🧠 Retention Rate:</strong> ${video.retention.toFixed(2)}%</li>
          <li><strong>💬 Engagements:</strong> ${video.total_engagements}</li>
          <li><strong>🔥 Engagement CTR:</strong> ${video.engagement_ctr.toFixed(2)}%</li>
          <li><strong>📈 New Subscribers:</strong> ${video.subscribers_gained}</li>
        </ul>
      </div>
    </div>
  `;

  document.getElementById('videoDetailContent').innerHTML = html;
  document.getElementById('videoDetailLink').href = `https://www.youtube.com/watch?v=${video.video_id}`;
  const modal = new bootstrap.Modal(document.getElementById('videoDetailModal'));
  modal.show();
}



  function initAnalyticsChart(chartData) {
    const ctx = document.getElementById('analyticsChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(54, 162, 235, 0.4)');
    gradient.addColorStop(1, 'rgba(54, 162, 235, 0.05)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: 'Views',
          data: chartData.values,
          borderColor: 'rgba(54, 162, 235, 1)',
          backgroundColor: gradient,
          borderWidth: 2,
          tension: 0.3,
          fill: true,
          pointBackgroundColor: 'white',
          pointBorderColor: 'rgba(54, 162, 235, 1)',
          pointBorderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            grid: { display: false },
            ticks: { maxRotation: 45, minRotation: 45 }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.7)',
            padding: 10,
            cornerRadius: 6,
            displayColors: false,
            callbacks: {
              label: ctx => `Views: ${ctx.parsed.y.toLocaleString()}`
            }
          },
          title: {
            display: true,
            text: 'Daily View Growth',
            align: 'center',
            font: { size: 18, weight: 'bold' },
            padding: { bottom: 20 }
          }
        },
        interaction: { mode: 'index', intersect: false },
        elements: { line: { capBezierPoints: true } }
      }
    });
  }

  function initPerVideoAnalytics() {
    const sortSelect = document.getElementById('sortBy');
    const searchInput = document.getElementById('searchVideos');
    const tableBody = document.querySelector('.video-analytics-table tbody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));

    // Sort videos
    sortSelect.addEventListener('change', () => {
      const val = sortSelect.value;
      let sortedRows = [...rows];
      if (val === 'views_desc') {
        sortedRows.sort((a,b) => parseInt(b.querySelector('.metric-value').textContent) - parseInt(a.querySelector('.metric-value').textContent));
      } else if (val === 'views_asc') {
        sortedRows.sort((a,b) => parseInt(a.querySelector('.metric-value').textContent) - parseInt(b.querySelector('.metric-value').textContent));
      } else if (val === 'title') {
        sortedRows.sort((a,b) => a.querySelector('.video-title').textContent.localeCompare(b.querySelector('.video-title').textContent));
      } else if (val === 'video_id') {
        sortedRows.sort((a,b) => a.cells[2].textContent.localeCompare(b.cells[2].textContent));
      }
      tableBody.innerHTML = '';
      sortedRows.forEach(row => tableBody.appendChild(row));
    });

    // Search videos
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      rows.forEach(row => {
        const title = row.querySelector('.video-title').textContent.toLowerCase();
        const videoId = row.cells[2].textContent.toLowerCase();
        row.style.display = (title.includes(term) || videoId.includes(term)) ? '' : 'none';
      });
    });
  }
</script>
{% endblock %}
