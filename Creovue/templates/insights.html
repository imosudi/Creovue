<!-- templates/audience_insights.html -->
{% extends 'dashboard_base.html' %}

    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .chart-container {
            position: relative;
            height: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .progress-modern {
            height: 8px;
            border-radius: 20px;
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
        }
        .progress-bar-modern {
            border-radius: 20px;
            background: linear-gradient(90deg, #28a745, #20c997);
        }
        .card-modern {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        .card-modern:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .table-modern {
            border-radius: 10px;
            overflow: hidden;
        }
        .table-modern thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
        }
        .empty-state i {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 20px;
        }
    </style>
{% block dashboard_main %}
<!-- Top Bar -->
<header class="topbar">
    <div class="d-flex justify-content-between align-items-center">
      <h1 class="h4 mb-0 text-gray-800">Audience Insights</h1>
      <div class="d-flex align-items-center">
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            {% if current_user.profile_pic %}
              <img src="{{ url_for('static', filename='uploads/' + current_user.profile_pic) }}" alt="Profile" width="32" height="32" class="rounded-circle me-2">
            {% else %}
                <i class="bi bi-person-circle me-1"></i>
                <span class="me-2">{{ current_user.username }}</span>
            {% endif %}
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
            <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <div id="dashboard-container">
    <div class="loading-spinner">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>
<script>
    // Sample insights data (replace with your dynamic data)
    const insights = {
        'demographics': {'age_groups': {}, 'gender': {}, 'countries': {}, 'last_updated': '2025-05-24T02:41:31.078728'}, 
        'geographic_data': {}, 
        'viewing_behaviour': {
            'traffic_sources': {
                'YT_SEARCH': {'views': 4, 'watch_time_minutes': 1, 'percentage': 80.0, 'avg_duration_seconds': 15.0}, 
                'EXT_URL': {'views': 1, 'watch_time_minutes': 0, 'percentage': 20.0, 'avg_duration_seconds': 0.0}
            }, 
            'device_preferences': {
                'DESKTOP': {'views': 5, 'watch_time_minutes': 1, 'percentage': 100.0, 'avg_duration_seconds': 12.0}
            }, 
            'viewing_patterns': {}
        }, 
        'subscription_trends': {
            'total_gained': 0, 'total_lost': 0, 'net_growth': 0, 'growth_rate': 0
        }, 
        'engagement_overview': {
            'total_views': 5, 'total_likes': 0, 'total_comments': 0, 'total_shares': 0, 
            'total_watch_time_minutes': 1, 'average_view_duration_seconds': 14, 
            'engagement_rate': 0.0, 'like_ratio': 0.0, 'comment_ratio': 0.0
        }, 
        'device_preferences': {
            'device_types': {
                'DESKTOP': {'views': 5, 'watch_time_minutes': 1, 'average_view_duration': 14, 'subscribers_gained': 0, 'percentage_of_views': 100.0, 'engagement_quality': 5.72}
            }, 
            'operating_systems': {
                'WINDOWS': {'views': 2, 'watch_time_minutes': 0, 'percentage_of_views': 40.0}, 
                'MACINTOSH': {'views': 2, 'watch_time_minutes': 0, 'percentage_of_views': 40.0}, 
                'LINUX': {'views': 1, 'watch_time_minutes': 0, 'percentage_of_views': 20.0}
            }
        }, 
        'traffic_sources': {
            'traffic_types': {
                'YT_SEARCH': {'views': 4, 'watch_time_minutes': 1, 'average_view_duration': 17, 'percentage_of_views': 80.0, 'label': 'YouTube Search'}, 
                'EXT_URL': {'views': 1, 'watch_time_minutes': 0, 'average_view_duration': 2, 'percentage_of_views': 20.0, 'label': 'External URL'}
            },
            'recommendations': [
                {'type': 'diversification', 'priority': 'high', 'title': 'Diversify Traffic Sources', 'description': 'Over 60% of traffic comes from YouTube Search. Work on developing other traffic sources for stability.'}
            ]
        }, 
        'content_preferences': {
            'content_performance': {
                'top_performers': [
                    {'video_id': 'DEQiARP_DiU', 'title': 'Ansible Automation of EC2 Instance, Docker CE, Icinga2, Icingaweb2', 'duration': 3892, 'views': 2, 'average_view_duration': 18, 'retention_rate': 0.46, 'performance_score': 1.26},
                    {'video_id': 'FBZ21CjR_A4', 'title': 'Ansible Automation of EC2 Instance, Docker CE, Icinga2, Icingaweb2', 'duration': 4141, 'views': 3, 'average_view_duration': 12, 'retention_rate': 0.29, 'performance_score': 0.84}
                ]
            },
            'recommendations': [
                {'type': 'content_focus', 'priority': 'high', 'title': 'Focus on Unknown Content', 'description': 'Unknown content shows the highest average performance score of 1.1.'},
                {'type': 'video_length', 'priority': 'medium', 'title': 'Optimize Video Length', 'description': 'Very long videos show the best engagement rates.'}
            ]
        }
    };

    function formatDuration(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return minutes > 0 ? `${minutes}m ${remainingSeconds}s` : `${seconds}s`;
    }

    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    function generateMetricCards(insights) {
        const metrics = [
            {
                icon: 'fas fa-eye',
                value: formatNumber(insights.engagement_overview?.total_views || 0),
                label: 'Total Views',
                variant: ''
            },
            {
                icon: 'fas fa-clock',
                value: insights.engagement_overview?.total_watch_time_minutes || 0,
                label: 'Minutes Watched',
                variant: 'variant-1'
            },
            {
                icon: 'fas fa-chart-line',
                value: formatDuration(insights.engagement_overview?.average_view_duration_seconds || 0),
                label: 'Avg Duration',
                variant: 'variant-2'
            },
            {
                icon: 'fas fa-users',
                value: insights.subscription_trends?.net_growth || 0,
                label: 'Subscribers',
                variant: 'variant-3'
            }
        ];

        return metrics.map(metric => `
            <div class="col-md-3">
                <div class="card metric-card ${metric.variant} h-100 p-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="${metric.icon} stat-icon"></i>
                        </div>
                        <div>
                            <h3 class="mb-1">${metric.value}</h3>
                            <p class="mb-0 opacity-75">${metric.label}</p>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function generateTrafficSources(insights) {
        const trafficSources = insights.traffic_sources?.traffic_types || {};
        const sources = Object.entries(trafficSources);
        
        if (sources.length === 0) {
            return `
                <div class="empty-state">
                    <i class="fas fa-share-alt"></i>
                    <h4>No Traffic Data Available</h4>
                    <p class="text-muted">Traffic source data will appear here once you have viewership data.</p>
                </div>
            `;
        }

        const sourcesList = sources.map(([key, data]) => `
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">${data.label || key.replace('_', ' ')}</span>
                    <span class="badge bg-primary">${Math.round(data.percentage_of_views)}%</span>
                </div>
                <div class="progress progress-modern">
                    <div class="progress-bar progress-bar-modern" style="width: ${data.percentage_of_views}%"></div>
                </div>
                <small class="text-muted">${data.views} views • ${data.watch_time_minutes} min watch time</small>
            </div>
        `).join('');

        return `
            <div class="row">
                <div class="col-md-6">
                    ${sourcesList}
                </div>
                <div class="col-md-6">
                    <div class="chart-container d-flex align-items-center justify-content-center">
                        <canvas id="trafficChart" width="200" height="200"></canvas>
                    </div>
                </div>
            </div>
        `;
    }

    function generateDeviceUsage(insights) {
        const deviceTypes = insights.device_preferences?.device_types || {};
        const operatingSystems = insights.device_preferences?.operating_systems || {};
        
        const deviceList = Object.entries(deviceTypes).map(([device, data]) => `
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium"><i class="fas fa-${device.toLowerCase()}"></i> ${device}</span>
                    <span class="badge bg-success">${Math.round(data.percentage_of_views)}%</span>
                </div>
                <div class="progress progress-modern">
                    <div class="progress-bar progress-bar-modern" style="width: ${data.percentage_of_views}%"></div>
                </div>
                <small class="text-muted">${data.views} views • Quality Score: ${data.engagement_quality?.toFixed(2) || 'N/A'}</small>
            </div>
        `).join('');

        const osList = Object.entries(operatingSystems).map(([os, data]) => `
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <span>${os.charAt(0) + os.slice(1).toLowerCase()}</span>
                    <span>${Math.round(data.percentage_of_views)}%</span>
                </div>
            </div>
        `).join('');

        return `
            ${deviceList}
            ${osList.length > 0 ? `
                <div class="mt-4">
                    <h6 class="text-muted mb-3">Operating Systems</h6>
                    ${osList}
                </div>
            ` : ''}
        `;
    }

    function generateContentTable(insights) {
        const topPerformers = insights.content_preferences?.content_performance?.top_performers || [];
        
        if (topPerformers.length === 0) {
            return `
                <div class="empty-state">
                    <i class="fas fa-video"></i>
                    <h4>No Content Data Available</h4>
                    <p class="text-muted">Content performance data will appear here once you have video analytics.</p>
                </div>
            `;
        }

        const rows = topPerformers.map(video => `
            <tr>
                <td>
                    <div class="fw-medium">${video.title}</div>
                    <small class="text-muted">ID: ${video.video_id}</small>
                </td>
                <td><span class="badge bg-primary">${video.views}</span></td>
                <td>${formatDuration(video.duration)}</td>
                <td>${formatDuration(video.average_view_duration)}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress progress-modern me-2" style="width: 60px; height: 6px;">
                            <div class="progress-bar progress-bar-modern" style="width: ${(video.retention_rate * 100)}%"></div>
                        </div>
                        <small>${Math.round(video.retention_rate * 100)}%</small>
                    </div>
                </td>
                <td><span class="badge ${video.performance_score > 1 ? 'bg-success' : 'bg-warning'}">${video.performance_score?.toFixed(2)}</span></td>
            </tr>
        `).join('');

        return `
            <div class="table-responsive">
                <table class="table table-modern table-hover">
                    <thead>
                        <tr>
                            <th>Video Title</th>
                            <th>Views</th>
                            <th>Duration</th>
                            <th>Avg Watch Time</th>
                            <th>Retention</th>
                            <th>Performance Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            </div>
        `;
    }

    function generateRecommendations(insights) {
        const trafficRecs = insights.traffic_sources?.recommendations || [];
        const contentRecs = insights.content_preferences?.recommendations || [];
        
        const trafficRecsHtml = trafficRecs.map(rec => `
            <div class="alert alert-${rec.priority === 'high' ? 'warning' : 'info'} border-0" style="background: linear-gradient(135deg, ${rec.priority === 'high' ? '#fff3cd 0%, #ffeaa7 100%' : '#d1ecf1 0%, #bee5eb 100%'});">
                <div class="d-flex">
                    <i class="fas fa-${rec.priority === 'high' ? 'exclamation-triangle' : 'info-circle'} me-3 mt-1"></i>
                    <div>
                        <h6 class="mb-1">${rec.title}</h6>
                        <p class="mb-0">${rec.description}</p>
                    </div>
                </div>
            </div>
        `).join('');

        const contentRecsHtml = contentRecs.map(rec => `
            <div class="alert alert-${rec.priority === 'high' ? 'warning' : 'info'} border-0" style="background: linear-gradient(135deg, ${rec.priority === 'high' ? '#fff3cd 0%, #ffeaa7 100%' : '#d1ecf1 0%, #bee5eb 100%'});">
                <div class="d-flex">
                    <i class="fas fa-${rec.priority === 'high' ? 'lightbulb' : 'chart-bar'} me-3 mt-1"></i>
                    <div>
                        <h6 class="mb-1">${rec.title}</h6>
                        <p class="mb-0">${rec.description}</p>
                    </div>
                </div>
            </div>
        `).join('');

        return { trafficRecsHtml, contentRecsHtml };
    }

    function generateDemographics(insights) {
        const demographics = insights.demographics || {};
        const hasData = Object.keys(demographics.age_groups || {}).length > 0 || 
                       Object.keys(demographics.gender || {}).length > 0 || 
                       Object.keys(demographics.countries || {}).length > 0;

        if (!hasData) {
            return `
                <div class="row g-4 mt-2">
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>Demographics Data Not Available</h4>
                            <p class="text-muted">Audience demographics will appear here once you have sufficient viewership data. Keep creating content to unlock detailed audience insights!</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate demographics charts if data exists
        return `
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card card-modern h-100">
                        <div class="card-header bg-transparent">
                            <h5 class="mb-0">Age Demographics</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="ageChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function generateDashboard(insights) {
        const recommendations = generateRecommendations(insights);
        
        return `
            <div class="container-fluid py-4">
                <!-- Key Metrics Overview -->
                <div class="row g-4 mb-4">
                    ${generateMetricCards(insights)}
                </div>

                <!-- Traffic Sources & Device Usage -->
                <div class="row g-4 mb-4">
                    <div class="col-md-8">
                        <div class="card card-modern h-100">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h5 class="mb-0"><i class="fas fa-share-alt me-2"></i>Traffic Sources</h5>
                            </div>
                            <div class="card-body">
                                ${generateTrafficSources(insights)}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-modern h-100">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h5 class="mb-0"><i class="fas fa-desktop me-2"></i>Device Usage</h5>
                            </div>
                            <div class="card-body">
                                ${generateDeviceUsage(insights)}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Performance -->
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card card-modern">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h5 class="mb-0"><i class="fas fa-video me-2"></i>Top Performing Content</h5>
                            </div>
                            <div class="card-body">
                                ${generateContentTable(insights)}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="row g-4 mb-4">
                    ${recommendations.trafficRecsHtml ? `
                        <div class="col-md-6">
                            <div class="card card-modern">
                                <div class="card-header bg-transparent border-0 pb-0">
                                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Traffic Recommendations</h5>
                                </div>
                                <div class="card-body">
                                    ${recommendations.trafficRecsHtml}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    ${recommendations.contentRecsHtml ? `
                        <div class="col-md-6">
                            <div class="card card-modern">
                                <div class="card-header bg-transparent border-0 pb-0">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Content Recommendations</h5>
                                </div>
                                <div class="card-body">
                                    ${recommendations.contentRecsHtml}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- Demographics -->
                ${generateDemographics(insights)}
            </div>
        `;
    }

    function createTrafficChart() {
        const canvas = document.getElementById('trafficChart');
        if (!canvas) return;

        const trafficData = insights.traffic_sources?.traffic_types || {};
        const labels = Object.values(trafficData).map(item => item.label || 'Unknown');
        const data = Object.values(trafficData).map(item => item.percentage_of_views || 0);
        const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];

        new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('dashboard-container');
        container.innerHTML = generateDashboard(insights);
        
        // Create charts after DOM is ready
        setTimeout(() => {
            createTrafficChart();
        }, 100);
    });

    // Function to update dashboard with new data (call this when data changes)
    function updateDashboard(newInsights) {
        const container = document.getElementById('dashboard-container');
        container.innerHTML = generateDashboard(newInsights);
        setTimeout(() => {
            createTrafficChart();
        }, 100);
    }

    // Export function for external use
    window.updateYouTubeDashboard = updateDashboard;
</script>
{% endblock %}